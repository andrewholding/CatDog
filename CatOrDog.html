<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.547">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Andrew Holding">

<title>Writing your own AI image classifier in R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="CatOrDog_files/libs/clipboard/clipboard.min.js"></script>
<script src="CatOrDog_files/libs/quarto-html/quarto.js"></script>
<script src="CatOrDog_files/libs/quarto-html/popper.min.js"></script>
<script src="CatOrDog_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="CatOrDog_files/libs/quarto-html/anchor.min.js"></script>
<link href="CatOrDog_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="CatOrDog_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="CatOrDog_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="CatOrDog_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="CatOrDog_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Writing your own AI image classifier in R</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Andrew Holding </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="building-your-first-classifier" class="level1">
<h1>Building your first classifier</h1>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>The aim of this tutorial is to provide you with the tools to generate an AI that can classify a set of images into one of two different categories. The code below will learn to classify an image as either ‘cat’ or ‘dog’, using a public set of 2000 images to train and another 1000 to validate. For the first part of the tutorial, we will apply a form of machine learning called logistic regression. For the second part we will introduce how to use a convolutional neural network (CNN) in place of the the logistic regression for more accuracy.</p>
<p><strong>An important technicality</strong>: logistic regression can be thought of as the simplest form of AI, as logistic regression is very similar to AI but with a single layer. This similarity makes logistic regression a good starting point for introducing the concepts needed for AI methods, and when we get to the point of introducing more layers into the algorithm hopefully these concepts of what a layer is will be more clear. However, since a feature of an AI is the use of multiple layers, we should use the more general term of machine learning to formally describe logistic regression.</p>
</section>
<section id="configuring-a-machine-learning-environment-in-r" class="level2">
<h2 class="anchored" data-anchor-id="configuring-a-machine-learning-environment-in-r">Configuring a machine learning environment in R</h2>
<p>As much of the teaching up to this point is in R, we wrote this tutorial with R users in mind; however, much of the AI work is easiest using tools written in Python, e.g.&nbsp;TensorFlow. To work around this challenge, we use the following packages, in particular a package called ‘reticulate’, that enables the use of Python packages in R. The block of code below will install the R packages we need for this tutorial, if not installed, and then load them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># List of packages to check and install if missing</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>packages_to_install <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"keras"</span>, <span class="st">"tensorflow"</span>, <span class="st">"raster"</span>, <span class="st">"reticulate"</span>, <span class="st">"caret"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if each package is installed, and install it if missing</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (package <span class="cf">in</span> packages_to_install) {</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(package, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(package, <span class="at">repos =</span> <span class="st">"http://cran.us.r-project.org"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(package, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: sp</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: ggplot2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: lattice</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'caret'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:tensorflow':

    train</code></pre>
</div>
</div>
<p>Once the packages are installed you may need to install the following Python on your computer too. It’s best to run these manually and then restart R. Once installed you don’t need to rerun this code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Download and install necessary Python packages (if needed)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># within python used by R</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Usually don't install packages in markdown, but this is to help you get going.</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">use_python</span>(<span class="st">"/opt/apps/eb/software/Python/3.10.8-GCCcore-12.2.0/bin/python"</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">#reticulate::install_python()</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">#install_tensorflow(envname = "r-tensorflow")</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">#install_keras(envname = "r-tensorflow")</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">#use_virtualenv("r-tensorflow")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="downloading-the-training-and-validation-data" class="level2">
<h2 class="anchored" data-anchor-id="downloading-the-training-and-validation-data">Downloading the training and validation data</h2>
<p>We need to download the images to train and validate our logistic regression model. The download contains two sets of images, the first is the training set, and the second is the validation set. We must not use the validation images for training, as if our model has already seen the images in training, during our validation we can run into a problem called over-fitting. Over-fitting is where our model has learnt to recognize the images too specifically, and when we try to classify new images the classifier does poorly because the model has learnt not to look for the general features but the exact images themselves. We’ll discuss this again at the training step.<br>
<br>
The code block below will download the images to you desktop.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Download the dataset</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">"https://storage.googleapis.com/mledu-datasets/cats_and_dogs_filtered.zip"</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>zip_file <span class="ot">&lt;-</span> <span class="st">"cats_and_dogs_filtered.zip"</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(url, zip_file)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">unzip</span>(zip_file, <span class="at">exdir =</span> <span class="st">"cats_and_dogs_dataset"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="configuring-training-and-validation-data-sets" class="level2">
<h2 class="anchored" data-anchor-id="configuring-training-and-validation-data-sets">Configuring training and validation data sets</h2>
<p>Next, we load the training and validation sets. In this case, the training and validation data sets have a folder of ‘cats’ and ‘dogs’. If you look into these folders, you will find a series of dog or cat images that match the folder name.</p>
<p>The first set of this code block is to set up the ‘image_data_generator’. This function can do more than we use it for here, for now; however, we’re just using it to rescale the image pixels from 0-255 to 0-1.</p>
<p>Traditionally a pixel is defined by three values for red, green and blue (R, G, B) measured as a whole number (integer) between 0 and 255. Bright red is (255,0,0), and dark purple would be (128,0,128). For our code, we want each pixel’s data in the format of 0 to 1 as a decimal as red=(1,0,0) or dark purple=(0.5,0,0.5). Using decimals between 0 and 1 is convenient in machine learning as 1 times 1 is never greater than 1, while 0 times 0 is never less than 0. 255 times 255; however, is much larger than 255.</p>
<p>(The reason colours are usually stored as 0-255 is due to them being stored as 8-bit binary channels, (i.e.&nbsp;the largest number you can write with 8-bits is 11111111 = 255); however, you don’t need to understand that for this tutorial.)<br>
<br>
The next parameter is the batch size, this is our first hyperparameter, i.e.&nbsp;a parameter that defines how the machine learning learns. The smaller the batch size the slower the machine learning will run; however, the larger the batch size the more computationally intensive the process is. We use 32 here to keep things workable on a laptop. The reason GPUs, originally sold for computer games, are so popular for machine learning is they are able to process very large batch sizes.</p>
<p>We then apply the ‘flow_images_from_directory’ command to define our two datasets. You’ll notice we specify the datagen, and we also provide a target size. The target size is important. We want our data all to be the same size, otherwise, if all the dog images are slightly larger the model may just start learning the size of the image instead of the contents of it. This process is all part of regularization, making the images as similar as possible except for the features we wish to learn. We also specify that the class mode is ‘binary’, i.e.&nbsp;we have two categories, ‘Dog’ or ‘Cat’.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the directories for training and validation data</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>train_dir <span class="ot">&lt;-</span> <span class="st">"cats_and_dogs_dataset/cats_and_dogs_filtered/train"</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>validation_dir <span class="ot">&lt;-</span> <span class="st">"cats_and_dogs_dataset/cats_and_dogs_filtered/validation"</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data Augmentation</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>datagen <span class="ot">&lt;-</span> <span class="fu">image_data_generator</span>(</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">rescale =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">255</span>,            <span class="co"># Rescale pixel values to the range [0, 1]</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the batch size</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>batch_size <span class="ot">&lt;-</span> <span class="dv">32</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data generators for training data</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>train_datagen <span class="ot">&lt;-</span> <span class="fu">flow_images_from_directory</span>(</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  train_dir,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">generator =</span> datagen,</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_size =</span> <span class="fu">c</span>(<span class="dv">150</span>, <span class="dv">150</span>),</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> batch_size,</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">class_mode =</span> <span class="st">"binary"</span>  </span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found 2000 images belonging to 2 classes.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data generators for validation data</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>validation_datagen <span class="ot">&lt;-</span> <span class="fu">flow_images_from_directory</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  validation_dir,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">generator =</span> datagen,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_size =</span> <span class="fu">c</span>(<span class="dv">150</span>, <span class="dv">150</span>),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> batch_size,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">class_mode =</span> <span class="st">"binary"</span> </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found 1000 images belonging to 2 classes.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the number of training samples</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>n_train_samples <span class="ot">&lt;-</span> <span class="fu">length</span>(train_datagen<span class="sc">$</span>filenames)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the number of validation samples</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>n_validation_samples <span class="ot">&lt;-</span> <span class="fu">length</span>(validation_datagen<span class="sc">$</span>filenames)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="defining-the-model" class="level2">
<h2 class="anchored" data-anchor-id="defining-the-model">Defining the model</h2>
<p>For this example, we are defining a logistic regression model. These models take all the pixels from our image, defined as 150 x 150 pixels x 3 colours as defined in the last code block into the first layer and combine them into a single ‘sigmoid’ output. Sigmoid functions are very useful for binary classifiers as they take any number from -infinity to +infinity and convert it to a value of 0 to 1, i.e.&nbsp;a probability.</p>
<p>The learning will then weigh how all the pixels contribute to the final value which is converted to the sigmoid function to a probability.</p>
<p>Here we also define a a few hyperparameters. The learning rate is the speed at which the model updates the weighting of each pixel in the mode. A fast learning rate is not always good as it can lead the model to overshoot and never find the best weightings. Early stopping also enables the model to roll back to a better model if an overshoot happens.</p>
<p>Finally, we compile the model. There are a few things here to improve our model from the start. The optimizer ‘optimizer_rmsprop’ is slightly smarter than the traditional stochastic gradient descent (SGD) ‘optimizer_sgd’ because RMSprop automates learning-rate tuning for us.</p>
<p>The optimizer is the core part of what we’re about to do. Each time we run a batch of images through the model we will generate a loss which is a measure of how accurate the model is. The SGD would then look at how changing the weighting to each alters the loss (if you’ve done A-Level math, this can be done via differentiation), and steps an amount by the learning rate towards parameters that give lower loss. The process is repeated time and time again with different images to fine-tune the weightings. This process of adjusting the weights on the basis of the loss function is called backpropagation.</p>
<p><br>
<img src="images/image-1828620369.png" class="img-fluid" width="495"></p>
<p><strong>Figure 1. Example logistic regression model.</strong><br>
</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a logistic regression model - a simple first example</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_flatten</span>(<span class="at">input_shape =</span> <span class="fu">c</span>(<span class="dv">150</span>, <span class="dv">150</span>, <span class="dv">3</span>)) <span class="sc">%&gt;%</span>  <span class="co"># Flatten the input image</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a> <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">1</span>, <span class="at">activation =</span> <span class="st">"sigmoid"</span>) </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Single dense layer with sigmoid activation</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Learning Rate Schedule with ReduceLRonPlateau</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>reduce_lr <span class="ot">&lt;-</span> <span class="fu">callback_reduce_lr_on_plateau</span>(</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">monitor =</span> <span class="st">"val_loss"</span>,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">factor =</span> <span class="fl">0.2</span>,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">patience =</span> <span class="dv">5</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Early Stopping</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>early_stop <span class="ot">&lt;-</span> <span class="fu">callback_early_stopping</span>(</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">monitor =</span> <span class="st">"val_loss"</span>,</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">patience =</span> <span class="dv">10</span>,</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">restore_best_weights =</span> <span class="cn">TRUE</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile the model</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="st">"binary_crossentropy"</span>,                      <span class="co"># Binary cross-entropy loss</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">optimizer =</span> <span class="fu">optimizer_rmsprop</span>(<span class="at">learning_rate =</span> <span class="fl">1e-3</span>),   <span class="co"># RMSprop optimizer </span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="fu">c</span>(<span class="st">"accuracy"</span>)                           <span class="co"># Monitor accuracy during training</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="training-the-model" class="level2">
<h2 class="anchored" data-anchor-id="training-the-model">Training the model</h2>
<p>With the model configured we can now train the model. As we do this R provides a plot of the loss function ouput (lower is better), the accuracy on the training set and accuracy on the validation set. And finally a plot of the learning rate, which is lowered as the scripts runs. The key new term here is ‘epoch’, an epoch is each time the training will run through the entire dataset.</p>
<p>An important point to note is if the training set accuracy continues to increase but the validation set’s accuracy does not increase it looks like we are at risk of over-fitting, you can see this in the plots for our the data at around the 6th epoch. This problem is something we must avoid. By about epoch 11, the problem is very apparent. Despite the prediction accuracy on the training set continuing to improve the prediction of the validation data set is now getting worse.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train the logistic regression model with callbacks</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>history <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  train_datagen,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">steps_per_epoch =</span> n_train_samples <span class="sc">/</span> batch_size,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">20</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_data =</span> validation_datagen,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_steps =</span> n_validation_samples <span class="sc">/</span> batch_size,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">callbacks =</span> <span class="fu">list</span>(reduce_lr, early_stop)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/20
62/62 - 15s - loss: 8.5327 - accuracy: 0.5020 - val_loss: 10.8308 - val_accuracy: 0.4980 - lr: 0.0010 - 15s/epoch - 235ms/step
Epoch 2/20
62/62 - 16s - loss: 6.7309 - accuracy: 0.5086 - val_loss: 7.2716 - val_accuracy: 0.5060 - lr: 0.0010 - 16s/epoch - 253ms/step
Epoch 3/20
62/62 - 16s - loss: 6.6719 - accuracy: 0.5346 - val_loss: 6.0264 - val_accuracy: 0.5071 - lr: 0.0010 - 16s/epoch - 265ms/step
Epoch 4/20
62/62 - 9s - loss: 6.4728 - accuracy: 0.5376 - val_loss: 11.4201 - val_accuracy: 0.4990 - lr: 0.0010 - 9s/epoch - 148ms/step
Epoch 5/20
62/62 - 4s - loss: 6.9331 - accuracy: 0.5056 - val_loss: 3.9150 - val_accuracy: 0.5272 - lr: 0.0010 - 4s/epoch - 63ms/step
Epoch 6/20
62/62 - 4s - loss: 6.4810 - accuracy: 0.5381 - val_loss: 2.2107 - val_accuracy: 0.5575 - lr: 0.0010 - 4s/epoch - 65ms/step
Epoch 7/20
62/62 - 4s - loss: 6.2465 - accuracy: 0.5467 - val_loss: 6.1399 - val_accuracy: 0.5121 - lr: 0.0010 - 4s/epoch - 72ms/step
Epoch 8/20
62/62 - 4s - loss: 6.5165 - accuracy: 0.5325 - val_loss: 4.4730 - val_accuracy: 0.5242 - lr: 0.0010 - 4s/epoch - 65ms/step
Epoch 9/20
62/62 - 4s - loss: 6.2012 - accuracy: 0.5549 - val_loss: 9.3239 - val_accuracy: 0.5050 - lr: 0.0010 - 4s/epoch - 67ms/step
Epoch 10/20
62/62 - 4s - loss: 6.6987 - accuracy: 0.5203 - val_loss: 3.4803 - val_accuracy: 0.5565 - lr: 0.0010 - 4s/epoch - 68ms/step
Epoch 11/20
62/62 - 4s - loss: 6.3365 - accuracy: 0.5376 - val_loss: 5.5810 - val_accuracy: 0.5202 - lr: 0.0010 - 4s/epoch - 70ms/step
Epoch 12/20
62/62 - 4s - loss: 1.6711 - accuracy: 0.6331 - val_loss: 1.8226 - val_accuracy: 0.5847 - lr: 2.0000e-04 - 4s/epoch - 65ms/step
Epoch 13/20
62/62 - 4s - loss: 1.4055 - accuracy: 0.6550 - val_loss: 2.0128 - val_accuracy: 0.5706 - lr: 2.0000e-04 - 4s/epoch - 67ms/step
Epoch 14/20
62/62 - 4s - loss: 1.3434 - accuracy: 0.6443 - val_loss: 1.4790 - val_accuracy: 0.5736 - lr: 2.0000e-04 - 4s/epoch - 62ms/step
Epoch 15/20
62/62 - 4s - loss: 1.2023 - accuracy: 0.6667 - val_loss: 1.5228 - val_accuracy: 0.5645 - lr: 2.0000e-04 - 4s/epoch - 60ms/step
Epoch 16/20
62/62 - 4s - loss: 1.1872 - accuracy: 0.6519 - val_loss: 1.2880 - val_accuracy: 0.5837 - lr: 2.0000e-04 - 4s/epoch - 66ms/step
Epoch 17/20
62/62 - 4s - loss: 1.2661 - accuracy: 0.6377 - val_loss: 1.9117 - val_accuracy: 0.5343 - lr: 2.0000e-04 - 4s/epoch - 71ms/step
Epoch 18/20
62/62 - 4s - loss: 1.0816 - accuracy: 0.6509 - val_loss: 1.6557 - val_accuracy: 0.5575 - lr: 2.0000e-04 - 4s/epoch - 66ms/step
Epoch 19/20
62/62 - 4s - loss: 1.1402 - accuracy: 0.6479 - val_loss: 1.1591 - val_accuracy: 0.5806 - lr: 2.0000e-04 - 4s/epoch - 68ms/step
Epoch 20/20
62/62 - 4s - loss: 1.1150 - accuracy: 0.6336 - val_loss: 1.2019 - val_accuracy: 0.5726 - lr: 2.0000e-04 - 4s/epoch - 70ms/step</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the loss with each epoch</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(history)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CatOrDog_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="testing-the-model" class="level2">
<h2 class="anchored" data-anchor-id="testing-the-model">Testing the model</h2>
<p>Technically there is no need for the next block of code as the validation set was test as part of the plot above. Nonetheless, I always recommend testing your data manually to visually determine if the results make sense. Here we run the model on the validation set and label a set of images for us to review. The model is only just above ~55% accurate (which isn’t very good) but it gets the answer right more often than chance which is something.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the model </span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  batch <span class="ot">&lt;-</span> <span class="fu">generator_next</span>(validation_datagen)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  images <span class="ot">&lt;-</span> batch[[<span class="dv">1</span>]]</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  labels <span class="ot">&lt;-</span> batch[[<span class="dv">2</span>]]</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>( <span class="fu">dim</span>(images)[<span class="dv">1</span>] <span class="sc">&gt;</span> <span class="dv">5</span>) {</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>   predict_batch_size <span class="ot">&lt;-</span>  <span class="dv">5</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    predict_batch_size <span class="ot">&lt;-</span> <span class="fu">dim</span>(images)[<span class="dv">1</span>]</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  predictions<span class="ot">&lt;-</span>model <span class="sc">%&gt;%</span> <span class="fu">predict</span>(images)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1/1 - 0s - 137ms/epoch - 137ms/step</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>predict_batch_size) {</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  image <span class="ot">&lt;-</span> images[n,, , ]</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  label <span class="ot">&lt;-</span> labels[n]</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Display the image and label</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dim</span>(image)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (label<span class="sc">==</span><span class="dv">1</span>) {label<span class="ot">=</span><span class="st">"Dog"</span>} <span class="cf">else</span> {label<span class="ot">=</span><span class="st">"Cat"</span>}</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (predictions[n] <span class="sc">&gt;</span> <span class="fl">0.5</span> ) {guess<span class="ot">=</span><span class="st">"Dog"</span>} <span class="cf">else</span> {guess<span class="ot">=</span><span class="st">"Cat"</span>}</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  bImage<span class="ot">&lt;-</span><span class="fu">brick</span>(image)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crs</span>(bImage)<span class="ot">&lt;-</span><span class="st">"+proj=longlat"</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plotRGB</span>(bImage, <span class="at">colNA=</span><span class="dv">0</span>, <span class="at">scale=</span><span class="dv">1</span>, <span class="at">axes=</span><span class="cn">TRUE</span>, <span class="at">main=</span><span class="fu">paste0</span>(<span class="st">"Label: "</span>, label, <span class="st">",</span><span class="sc">\n</span><span class="st"> P="</span>, <span class="fu">round</span>(predictions[n],<span class="dv">2</span>), <span class="st">", Prediction: "</span>,guess))</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sys.sleep</span>(<span class="dv">1</span>) </span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CatOrDog_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CatOrDog_files/figure-html/unnamed-chunk-7-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CatOrDog_files/figure-html/unnamed-chunk-7-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CatOrDog_files/figure-html/unnamed-chunk-7-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CatOrDog_files/figure-html/unnamed-chunk-7-5.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="improving-the-model-with-cnn-ai" class="level1">
<h1>Improving the model with CNN (AI)</h1>
<section id="configuring-a-more-complex-model" class="level2">
<h2 class="anchored" data-anchor-id="configuring-a-more-complex-model">Configuring a more complex model</h2>
<p>Logistic regression is very good at some classification questions; however, for our test data it is not performing well. We are therefore going to apply a CCN. There are many ways to design a CNN, and below is just one that works well for this challenge. The selection of hyper parameters, i.e.&nbsp;the number of layers, the size of each layer is complex. Here however we have use to convolution layers (these extract features of the image) and two pooling layers (these reduce the number of dimensions of the data). We then finish by flattening the data and using a sigmoid function at the end to obtain a value between 0-1. How a convolution layer works requires a bit of knowledge on matrix algebra that is well worth learning.<br>
<br>
The layers also need an activation function, this mimics the activation function of a neuron but for simplicity we use the ‘relu’ function over a more biologically accurate function. The function is very simple; if x &lt; 0 then the output f(x) = 0, if x &gt; 0 then f(x) = x. The neuron is only active if the input is positive, and then the stronger the input the stronger the output.</p>
<p>We have also included a dropout layer. The drop out layer randomly disables nodes in our neural net during the learning to help prevent over fitting.<br>
<br>
Once configured we run as before. Again we see some signs of over fitting, with the accuracy of the test data set reaching 100%. but validation set only reaches 70%.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/image-1388631215.png" class="img-fluid figure-img"></p>
<figcaption><strong>Figure 2. Simplified illustration of our CNN model.</strong></figcaption>
</figure>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Define CNN</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Convolutional layers</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>modelCNN <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> <span class="dv">32</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">activation =</span> <span class="st">"relu"</span>, <span class="at">input_shape =</span> <span class="fu">c</span>(<span class="dv">150</span>, <span class="dv">150</span>, <span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_max_pooling_2d</span>(<span class="at">pool_size =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> <span class="dv">64</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>), <span class="at">activation =</span> <span class="st">"relu"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_max_pooling_2d</span>(<span class="at">pool_size =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> <span class="dv">128</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>), <span class="at">activation =</span> <span class="st">"relu"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_max_pooling_2d</span>(<span class="at">pool_size =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Flatten layer</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_flatten</span>() <span class="sc">%&gt;%</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fully connected layers</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">512</span>, <span class="at">activation =</span> <span class="st">"relu"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dropout</span>(<span class="fl">0.5</span>) <span class="sc">%&gt;%</span>  <span class="co"># Dropout for regularization</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Output layer</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">1</span>, <span class="at">activation =</span> <span class="st">"sigmoid"</span>)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile the model</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>modelCNN <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="st">"binary_crossentropy"</span>,                      <span class="co"># Binary cross-entropy loss</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimizer =</span> <span class="fu">optimizer_rmsprop</span>(<span class="at">learning_rate =</span> <span class="fl">1e-3</span>),   <span class="co"># RMSprop optimizer </span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="fu">c</span>(<span class="st">"accuracy"</span>)                           <span class="co"># Monitor accuracy during training</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Train the CNN model with callbacks</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>historyCNN <span class="ot">&lt;-</span> modelCNN <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>  train_datagen,</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">steps_per_epoch =</span> n_train_samples <span class="sc">/</span> batch_size,</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">20</span>,</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_data =</span> validation_datagen,</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_steps =</span> n_validation_samples <span class="sc">/</span> batch_size,</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">callbacks =</span> <span class="fu">list</span>(reduce_lr, early_stop)</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/20
62/62 - 18s - loss: 0.8036 - accuracy: 0.5102 - val_loss: 0.6858 - val_accuracy: 0.6179 - lr: 0.0010 - 18s/epoch - 296ms/step
Epoch 2/20
62/62 - 17s - loss: 0.6919 - accuracy: 0.5661 - val_loss: 0.6731 - val_accuracy: 0.5272 - lr: 0.0010 - 17s/epoch - 276ms/step
Epoch 3/20
62/62 - 20s - loss: 0.6656 - accuracy: 0.5940 - val_loss: 0.6253 - val_accuracy: 0.6462 - lr: 0.0010 - 20s/epoch - 330ms/step
Epoch 4/20
62/62 - 15s - loss: 0.6357 - accuracy: 0.6524 - val_loss: 0.6187 - val_accuracy: 0.6472 - lr: 0.0010 - 15s/epoch - 239ms/step
Epoch 5/20
62/62 - 14s - loss: 0.5784 - accuracy: 0.6987 - val_loss: 0.5633 - val_accuracy: 0.7056 - lr: 0.0010 - 14s/epoch - 231ms/step
Epoch 6/20
62/62 - 14s - loss: 0.5444 - accuracy: 0.7215 - val_loss: 0.5632 - val_accuracy: 0.7208 - lr: 0.0010 - 14s/epoch - 229ms/step
Epoch 7/20
62/62 - 15s - loss: 0.5153 - accuracy: 0.7576 - val_loss: 0.5440 - val_accuracy: 0.7258 - lr: 0.0010 - 15s/epoch - 235ms/step
Epoch 8/20
62/62 - 14s - loss: 0.4605 - accuracy: 0.7774 - val_loss: 0.6691 - val_accuracy: 0.6704 - lr: 0.0010 - 14s/epoch - 226ms/step
Epoch 9/20
62/62 - 14s - loss: 0.4208 - accuracy: 0.7983 - val_loss: 0.5255 - val_accuracy: 0.7550 - lr: 0.0010 - 14s/epoch - 227ms/step
Epoch 10/20
62/62 - 15s - loss: 0.3816 - accuracy: 0.8354 - val_loss: 0.5425 - val_accuracy: 0.7591 - lr: 0.0010 - 15s/epoch - 239ms/step
Epoch 11/20
62/62 - 14s - loss: 0.3260 - accuracy: 0.8567 - val_loss: 0.6421 - val_accuracy: 0.7036 - lr: 0.0010 - 14s/epoch - 231ms/step
Epoch 12/20
62/62 - 14s - loss: 0.2733 - accuracy: 0.8918 - val_loss: 0.7385 - val_accuracy: 0.7298 - lr: 0.0010 - 14s/epoch - 219ms/step
Epoch 13/20
62/62 - 14s - loss: 0.2088 - accuracy: 0.9172 - val_loss: 0.8794 - val_accuracy: 0.7288 - lr: 0.0010 - 14s/epoch - 226ms/step
Epoch 14/20
62/62 - 14s - loss: 0.1748 - accuracy: 0.9299 - val_loss: 0.7954 - val_accuracy: 0.7329 - lr: 0.0010 - 14s/epoch - 232ms/step
Epoch 15/20
62/62 - 14s - loss: 0.0576 - accuracy: 0.9893 - val_loss: 0.9330 - val_accuracy: 0.7379 - lr: 2.0000e-04 - 14s/epoch - 234ms/step
Epoch 16/20
62/62 - 15s - loss: 0.0378 - accuracy: 0.9924 - val_loss: 0.9207 - val_accuracy: 0.7510 - lr: 2.0000e-04 - 15s/epoch - 234ms/step
Epoch 17/20
62/62 - 14s - loss: 0.0285 - accuracy: 0.9939 - val_loss: 1.0271 - val_accuracy: 0.7470 - lr: 2.0000e-04 - 14s/epoch - 233ms/step
Epoch 18/20
62/62 - 14s - loss: 0.0239 - accuracy: 0.9934 - val_loss: 1.0487 - val_accuracy: 0.7540 - lr: 2.0000e-04 - 14s/epoch - 226ms/step
Epoch 19/20
62/62 - 15s - loss: 0.0184 - accuracy: 0.9959 - val_loss: 1.1382 - val_accuracy: 0.7540 - lr: 2.0000e-04 - 15s/epoch - 235ms/step</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(historyCNN)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CatOrDog_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="testing-your-cnn" class="level2">
<h2 class="anchored" data-anchor-id="testing-your-cnn">Testing your CNN</h2>
<p>We can use exactly the same code as before to test out model. The CNN in this version gets more like 70% accuracy, much improved over the logistic regression model we tried. The improvement results in many more of the images being correctly annotated in the validation set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the new model </span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  batch <span class="ot">&lt;-</span> <span class="fu">generator_next</span>(validation_datagen)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  images <span class="ot">&lt;-</span> batch[[<span class="dv">1</span>]]</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  labels <span class="ot">&lt;-</span> batch[[<span class="dv">2</span>]]</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>( <span class="fu">dim</span>(images)[<span class="dv">1</span>] <span class="sc">&gt;</span> <span class="dv">5</span>) {</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>   predict_batch_size <span class="ot">&lt;-</span>  <span class="dv">10</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    predict_batch_size <span class="ot">&lt;-</span> <span class="fu">dim</span>(images)[<span class="dv">1</span>]</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  predictions<span class="ot">&lt;-</span>modelCNN <span class="sc">%&gt;%</span> <span class="fu">predict</span>(images)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1/1 - 0s - 127ms/epoch - 127ms/step</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>predict_batch_size) {</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  image <span class="ot">&lt;-</span> images[n,, , ]</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  label <span class="ot">&lt;-</span> labels[n]</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Display the image and label</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dim</span>(image)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (label<span class="sc">==</span><span class="dv">1</span>) {label<span class="ot">=</span><span class="st">"Dog"</span>} <span class="cf">else</span> {label<span class="ot">=</span><span class="st">"Cat"</span>}</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (predictions[n] <span class="sc">&gt;</span> <span class="fl">0.5</span> ) {guess<span class="ot">=</span><span class="st">"Dog"</span>} <span class="cf">else</span> {guess<span class="ot">=</span><span class="st">"Cat"</span>}</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  bImage<span class="ot">&lt;-</span><span class="fu">brick</span>(image)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crs</span>(bImage)<span class="ot">&lt;-</span><span class="st">"+proj=longlat"</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plotRGB</span>(bImage, <span class="at">colNA=</span><span class="dv">0</span>, <span class="at">scale=</span><span class="dv">1</span>, <span class="at">axes=</span><span class="cn">TRUE</span>, <span class="at">main=</span><span class="fu">paste0</span>(<span class="st">"Label: "</span>, label, <span class="st">",</span><span class="sc">\n</span><span class="st"> P="</span>, <span class="fu">round</span>(predictions[n],<span class="dv">2</span>), <span class="st">", Prediction: "</span>,guess))</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sys.sleep</span>(<span class="dv">1</span>) </span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CatOrDog_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CatOrDog_files/figure-html/unnamed-chunk-9-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CatOrDog_files/figure-html/unnamed-chunk-9-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CatOrDog_files/figure-html/unnamed-chunk-9-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CatOrDog_files/figure-html/unnamed-chunk-9-5.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CatOrDog_files/figure-html/unnamed-chunk-9-6.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CatOrDog_files/figure-html/unnamed-chunk-9-7.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CatOrDog_files/figure-html/unnamed-chunk-9-8.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CatOrDog_files/figure-html/unnamed-chunk-9-9.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CatOrDog_files/figure-html/unnamed-chunk-9-10.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="validation-with-a-confusion-matrix" class="level2">
<h2 class="anchored" data-anchor-id="validation-with-a-confusion-matrix">Validation with a ‘Confusion Matrix’</h2>
<p>An additional way to validate our data is a confusion matrix. These are very useful for looking into the false-positive and false-negative rates. These provide some statistics on how well the model works, these would be critical in a clinical setting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>  batch <span class="ot">&lt;-</span> <span class="fu">generator_next</span>(validation_datagen)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  images <span class="ot">&lt;-</span> batch[[<span class="dv">1</span>]]</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  labels <span class="ot">&lt;-</span> batch[[<span class="dv">2</span>]]</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  predictions<span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(modelCNN <span class="sc">%&gt;%</span> </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">predict</span>(images) <span class="sc">%&gt;%</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>                             <span class="st">`</span><span class="at">&gt;</span><span class="st">`</span>(<span class="fl">0.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">k_cast</span>(<span class="st">"int32"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1/1 - 0s - 57ms/epoch - 57ms/step</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">confusionMatrix</span>(<span class="fu">as.factor</span>(predictions),<span class="fu">as.factor</span>(labels))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction  0  1
         0 12  5
         1  3 12
                                         
               Accuracy : 0.75           
                 95% CI : (0.566, 0.8854)
    No Information Rate : 0.5312         
    P-Value [Acc &gt; NIR] : 0.009441       
                                         
                  Kappa : 0.5019         
                                         
 Mcnemar's Test P-Value : 0.723674       
                                         
            Sensitivity : 0.8000         
            Specificity : 0.7059         
         Pos Pred Value : 0.7059         
         Neg Pred Value : 0.8000         
             Prevalence : 0.4688         
         Detection Rate : 0.3750         
   Detection Prevalence : 0.5312         
      Balanced Accuracy : 0.7529         
                                         
       'Positive' Class : 0              
                                         </code></pre>
</div>
</div>
</section>
</section>
<section id="what-next" class="level1">
<h1>What next?</h1>
<p>There are several options on taking this forward.</p>
<p>You could try to make the classifier more accurate, while trying reduce the problems with over-fitting. One option would be to included data augmentation (see example below), another would be to find more images to learn on. We could also alter the hyper-parameters and model design.<br>
<br>
Your final goal should be to try to set up a script that runs on biological data, a good source for data is <a href="https://www.kaggle.com/datasets/ambarish/breakhis">BreaKHis</a> or the simplified <a href="https://www.kaggle.com/datasets/forderation/breakhis-400x">BreaKHis 400X</a>, but feel free to find your own.</p>
<p>I’ve also provided some extenstions. These are minimal examples for you to undertake further reading on. Most of all, have fun.</p>
<section id="extension-1-data-augmentation" class="level2">
<h2 class="anchored" data-anchor-id="extension-1-data-augmentation">Extension 1: Data Augmentation</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data Augmentation: Enhance the training dataset with variations at datagen</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>datagen_variations <span class="ot">&lt;-</span> <span class="fu">image_data_generator</span>(</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">rescale =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">255</span>,            <span class="co"># Rescale pixel values to the range [0, 1]</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">rotation_range =</span> <span class="dv">40</span>, <span class="co"># Rotate images by up to 40</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">width_shift_range =</span> <span class="fl">0.2</span>, <span class="co"># Shift width by up to 20%</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">height_shift_range =</span> <span class="fl">0.2</span>, <span class="co"># Shift height by up to 20%</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">shear_range =</span> <span class="fl">0.2</span>, <span class="co"># Apply shear transformations</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">zoom_range =</span> <span class="fl">0.2</span>, <span class="co"># Zoom in or out by up to 20%</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">fill_mode =</span> <span class="st">"nearest"</span>, <span class="co"># Fill missing pixels using the nearest neighbour</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">horizontal_flip =</span> <span class="cn">TRUE</span> <span class="co"># Flip images horizontally</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data generators for training data</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>train_datagen_variations <span class="ot">&lt;-</span> <span class="fu">flow_images_from_directory</span>(</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>  train_dir,</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">generator =</span> datagen_variations,</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_size =</span> <span class="fu">c</span>(<span class="dv">150</span>, <span class="dv">150</span>),</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> batch_size,</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">class_mode =</span> <span class="st">"binary"</span>  </span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found 2000 images belonging to 2 classes.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data generators for validation data</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>validation_datagen_variations <span class="ot">&lt;-</span> <span class="fu">flow_images_from_directory</span>(</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  validation_dir,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">generator =</span> datagen_variations,</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_size =</span> <span class="fu">c</span>(<span class="dv">150</span>, <span class="dv">150</span>),</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> batch_size,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">class_mode =</span> <span class="st">"binary"</span> </span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found 1000 images belonging to 2 classes.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Define CNN as before</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Convolutional layers</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>modelCNN_variations <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> <span class="dv">32</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>),</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">activation =</span> <span class="st">"relu"</span>, <span class="at">input_shape =</span> <span class="fu">c</span>(<span class="dv">150</span>, <span class="dv">150</span>, <span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_max_pooling_2d</span>(<span class="at">pool_size =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> <span class="dv">64</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>), <span class="at">activation =</span> <span class="st">"relu"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_max_pooling_2d</span>(<span class="at">pool_size =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> <span class="dv">128</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>), <span class="at">activation =</span> <span class="st">"relu"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_max_pooling_2d</span>(<span class="at">pool_size =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Flatten layer</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_flatten</span>() <span class="sc">%&gt;%</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fully connected layers</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">512</span>, <span class="at">activation =</span> <span class="st">"relu"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dropout</span>(<span class="fl">0.5</span>) <span class="sc">%&gt;%</span>  <span class="co"># Dropout for regularization</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Output layer</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">1</span>, <span class="at">activation =</span> <span class="st">"sigmoid"</span>)</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile the model</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>modelCNN_variations <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="st">"binary_crossentropy"</span>,                      <span class="co"># Binary cross-entropy loss</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimizer =</span> <span class="fu">optimizer_rmsprop</span>(<span class="at">learning_rate =</span> <span class="fl">1e-3</span>),   <span class="co"># RMSprop optimizer </span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="fu">c</span>(<span class="st">"accuracy"</span>)                           <span class="co"># Monitor accuracy during training</span></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>historyCNN_variations <span class="ot">&lt;-</span> modelCNN_variations  <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>  train_datagen,</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">steps_per_epoch =</span> n_train_samples <span class="sc">/</span> batch_size,</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">20</span>,</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_data =</span> validation_datagen,</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_steps =</span> n_validation_samples <span class="sc">/</span> batch_size,</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">callbacks =</span> <span class="fu">list</span>(reduce_lr, early_stop)</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/20
62/62 - 15s - loss: 0.7594 - accuracy: 0.5086 - val_loss: 0.6907 - val_accuracy: 0.5000 - lr: 0.0010 - 15s/epoch - 241ms/step
Epoch 2/20
62/62 - 14s - loss: 0.6932 - accuracy: 0.5442 - val_loss: 0.6636 - val_accuracy: 0.5292 - lr: 0.0010 - 14s/epoch - 223ms/step
Epoch 3/20
62/62 - 14s - loss: 0.6485 - accuracy: 0.6260 - val_loss: 0.6162 - val_accuracy: 0.6562 - lr: 0.0010 - 14s/epoch - 220ms/step
Epoch 4/20
62/62 - 14s - loss: 0.6093 - accuracy: 0.6717 - val_loss: 0.6027 - val_accuracy: 0.6562 - lr: 0.0010 - 14s/epoch - 224ms/step
Epoch 5/20
62/62 - 14s - loss: 0.5807 - accuracy: 0.6870 - val_loss: 0.5669 - val_accuracy: 0.7036 - lr: 0.0010 - 14s/epoch - 233ms/step
Epoch 6/20
62/62 - 14s - loss: 0.5307 - accuracy: 0.7282 - val_loss: 0.5804 - val_accuracy: 0.6956 - lr: 0.0010 - 14s/epoch - 225ms/step
Epoch 7/20
62/62 - 14s - loss: 0.5115 - accuracy: 0.7520 - val_loss: 0.5500 - val_accuracy: 0.7288 - lr: 0.0010 - 14s/epoch - 232ms/step
Epoch 8/20
62/62 - 14s - loss: 0.4426 - accuracy: 0.7962 - val_loss: 0.5529 - val_accuracy: 0.7208 - lr: 0.0010 - 14s/epoch - 224ms/step
Epoch 9/20
62/62 - 14s - loss: 0.3972 - accuracy: 0.8125 - val_loss: 0.5935 - val_accuracy: 0.7157 - lr: 0.0010 - 14s/epoch - 232ms/step
Epoch 10/20
62/62 - 14s - loss: 0.3471 - accuracy: 0.8440 - val_loss: 0.6548 - val_accuracy: 0.6946 - lr: 0.0010 - 14s/epoch - 232ms/step
Epoch 11/20
62/62 - 14s - loss: 0.2854 - accuracy: 0.8791 - val_loss: 0.6502 - val_accuracy: 0.7218 - lr: 0.0010 - 14s/epoch - 230ms/step
Epoch 12/20
62/62 - 14s - loss: 0.2485 - accuracy: 0.9096 - val_loss: 0.7157 - val_accuracy: 0.7268 - lr: 0.0010 - 14s/epoch - 233ms/step
Epoch 13/20
62/62 - 15s - loss: 0.0999 - accuracy: 0.9731 - val_loss: 0.7313 - val_accuracy: 0.7530 - lr: 2.0000e-04 - 15s/epoch - 237ms/step
Epoch 14/20
62/62 - 14s - loss: 0.0692 - accuracy: 0.9807 - val_loss: 0.8015 - val_accuracy: 0.7510 - lr: 2.0000e-04 - 14s/epoch - 228ms/step
Epoch 15/20
62/62 - 14s - loss: 0.0551 - accuracy: 0.9822 - val_loss: 0.8542 - val_accuracy: 0.7591 - lr: 2.0000e-04 - 14s/epoch - 231ms/step
Epoch 16/20
62/62 - 15s - loss: 0.0471 - accuracy: 0.9868 - val_loss: 0.9035 - val_accuracy: 0.7540 - lr: 2.0000e-04 - 15s/epoch - 235ms/step
Epoch 17/20
62/62 - 15s - loss: 0.0332 - accuracy: 0.9914 - val_loss: 0.9362 - val_accuracy: 0.7520 - lr: 2.0000e-04 - 15s/epoch - 236ms/step</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(historyCNN_variations)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CatOrDog_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="extension-2-pre-trained-networks" class="level2">
<h2 class="anchored" data-anchor-id="extension-2-pre-trained-networks">Extension 2: Pre-trained Networks</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the directories for training and validation data</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>train_dir <span class="ot">&lt;-</span> <span class="st">"cats_and_dogs_dataset/cats_and_dogs_filtered/train"</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>validation_dir <span class="ot">&lt;-</span> <span class="st">"cats_and_dogs_dataset/cats_and_dogs_filtered/validation"</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data Augmentation - Keeping it simple again.</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>datagen <span class="ot">&lt;-</span> <span class="fu">image_data_generator</span>(</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">rescale =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">255</span>,            <span class="co"># Rescale pixel values to the range [0, 1]</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the batch size</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>batch_size <span class="ot">&lt;-</span> <span class="dv">32</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data generators for training data</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>train_datagen_244 <span class="ot">&lt;-</span> <span class="fu">flow_images_from_directory</span>(</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>  train_dir,</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">generator =</span> datagen,</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_size =</span> <span class="fu">c</span>(<span class="dv">224</span>, <span class="dv">224</span>),  <span class="co"># Note: We need to change the target size to match </span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>                              <span class="co"># the pretrained network</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> batch_size,</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">class_mode =</span> <span class="st">"binary"</span>  </span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found 2000 images belonging to 2 classes.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data generators for validation data</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>validation_datagen_244 <span class="ot">&lt;-</span> <span class="fu">flow_images_from_directory</span>(</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  validation_dir,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">generator =</span> datagen,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_size =</span> <span class="fu">c</span>(<span class="dv">224</span>, <span class="dv">224</span>),</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> batch_size,</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">class_mode =</span> <span class="st">"binary"</span> </span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found 1000 images belonging to 2 classes.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the number of training samples</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>n_train_samples_244 <span class="ot">&lt;-</span> <span class="fu">length</span>(train_datagen_244<span class="sc">$</span>filenames)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the number of validation samples</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>n_validation_samples_244 <span class="ot">&lt;-</span> <span class="fu">length</span>(validation_datagen_244<span class="sc">$</span>filenames)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="co">#Define CNN, we are going to load a premade net here, helpfully this is built into the</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="co">#R-package Keras.</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>efficientnetv2_b0 <span class="ot">&lt;-</span> keras<span class="sc">$</span>applications<span class="sc">$</span><span class="fu">EfficientNetV2B0</span>(</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">include_top =</span> <span class="cn">TRUE</span>,  <span class="co"># Set this to FALSE if you want to customize the top layers</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> <span class="st">"imagenet"</span>,  <span class="co"># Use pre-trained weights</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading data from https://storage.googleapis.com/tensorflow/keras-applications/efficientnet_v2/efficientnetv2-b0.h5

    8192/29403144 [..............................] - ETA: 0s
   49152/29403144 [..............................] - ETA: 38s
   81920/29403144 [..............................] - ETA: 50s
  229376/29403144 [..............................] - ETA: 24s
  507904/29403144 [..............................] - ETA: 13s
  786432/29403144 [..............................] - ETA: 10s
 1359872/29403144 [&gt;.............................] - ETA: 7s 
 2138112/29403144 [=&gt;............................] - ETA: 5s
 3497984/29403144 [==&gt;...........................] - ETA: 3s
 4931584/29403144 [====&gt;.........................] - ETA: 2s
 6520832/29403144 [=====&gt;........................] - ETA: 1s
 9388032/29403144 [========&gt;.....................] - ETA: 1s
10174464/29403144 [=========&gt;....................] - ETA: 1s
10698752/29403144 [=========&gt;....................] - ETA: 1s
14041088/29403144 [=============&gt;................] - ETA: 0s
15089664/29403144 [==============&gt;...............] - ETA: 0s
15712256/29403144 [===============&gt;..............] - ETA: 0s
16908288/29403144 [================&gt;.............] - ETA: 0s
20168704/29403144 [===================&gt;..........] - ETA: 0s
20692992/29403144 [====================&gt;.........] - ETA: 0s
22953984/29403144 [======================&gt;.......] - ETA: 0s
23871488/29403144 [=======================&gt;......] - ETA: 0s
25575424/29403144 [=========================&gt;....] - ETA: 0s
26099712/29403144 [=========================&gt;....] - ETA: 0s
29360128/29403144 [============================&gt;.] - ETA: 0s
29403144/29403144 [==============================] - 1s 0us/step</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build a single layer to take the output of the pre-trained</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co"># CNN and connect it to our sigmoid classifier.</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>model_sigmoid<span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fully connected layers</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">1000</span>, <span class="at">activation =</span> <span class="st">"relu"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dropout</span>(<span class="fl">0.5</span>) <span class="sc">%&gt;%</span>  <span class="co"># Dropout for regularization</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Normlise</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_batch_normalization</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Output layer</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">1</span>, <span class="at">activation =</span> <span class="st">"sigmoid"</span>)</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a><span class="co">#Combine the two networks</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>combined_model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>  efficientnetv2_b0 <span class="sc">%&gt;%</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>  model_sigmoid </span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a><span class="co">#Compile</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>combined_model <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="st">"binary_crossentropy"</span>,                      </span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimizer =</span> <span class="fu">optimizer_rmsprop</span>(<span class="at">learning_rate =</span> <span class="fl">1e-3</span>),</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="fu">c</span>(<span class="st">"accuracy"</span>)                           </span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a><span class="co">#Train as before</span></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>combined_model <span class="ot">&lt;-</span> combined_model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>  train_datagen_244,</span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">steps_per_epoch =</span> n_train_samples_244 <span class="sc">/</span> batch_size,</span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">10</span>,</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_data =</span> validation_datagen_244,</span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_steps =</span> n_validation_samples_244 <span class="sc">/</span> batch_size,</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">callbacks =</span> <span class="fu">list</span>(reduce_lr, early_stop)</span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/10
62/62 - 113s - loss: 0.3121 - accuracy: 0.8521 - val_loss: 0.6933 - val_accuracy: 0.5000 - lr: 0.0010 - 113s/epoch - 2s/step
Epoch 2/10
62/62 - 88s - loss: 0.1744 - accuracy: 0.9350 - val_loss: 0.6948 - val_accuracy: 0.5010 - lr: 0.0010 - 88s/epoch - 1s/step
Epoch 3/10
62/62 - 86s - loss: 0.1280 - accuracy: 0.9548 - val_loss: 0.6926 - val_accuracy: 0.4970 - lr: 0.0010 - 86s/epoch - 1s/step
Epoch 4/10
62/62 - 83s - loss: 0.1044 - accuracy: 0.9634 - val_loss: 0.6932 - val_accuracy: 0.4970 - lr: 0.0010 - 83s/epoch - 1s/step
Epoch 5/10
62/62 - 85s - loss: 0.0741 - accuracy: 0.9751 - val_loss: 0.6337 - val_accuracy: 0.7218 - lr: 0.0010 - 85s/epoch - 1s/step
Epoch 6/10
62/62 - 84s - loss: 0.0932 - accuracy: 0.9675 - val_loss: 0.6930 - val_accuracy: 0.4970 - lr: 0.0010 - 84s/epoch - 1s/step
Epoch 7/10
62/62 - 87s - loss: 0.0515 - accuracy: 0.9817 - val_loss: 0.6948 - val_accuracy: 0.5010 - lr: 0.0010 - 87s/epoch - 1s/step
Epoch 8/10
62/62 - 87s - loss: 0.0474 - accuracy: 0.9812 - val_loss: 0.7019 - val_accuracy: 0.5000 - lr: 0.0010 - 87s/epoch - 1s/step
Epoch 9/10
62/62 - 84s - loss: 0.0547 - accuracy: 0.9848 - val_loss: 0.7268 - val_accuracy: 0.5091 - lr: 0.0010 - 84s/epoch - 1s/step
Epoch 10/10
62/62 - 87s - loss: 0.0385 - accuracy: 0.9893 - val_loss: 0.6151 - val_accuracy: 0.6552 - lr: 0.0010 - 87s/epoch - 1s/step</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(combined_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CatOrDog_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="extension-3-digital-pathology" class="level2">
<h2 class="anchored" data-anchor-id="extension-3-digital-pathology">Extension 3: Digital Pathology</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># List of packages to check and install if missing</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>packages_to_install <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"keras"</span>, <span class="st">"tensorflow"</span>, <span class="st">"raster"</span>, <span class="st">"reticulate"</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if each package is installed, and install it if missing</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (package <span class="cf">in</span> packages_to_install) {</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(package, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(package)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(package, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>train_BreaKHis_dir<span class="ot">&lt;-</span> <span class="st">"BreaKHis 400X/train"</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>test_BreaKHis_dir<span class="ot">&lt;-</span> <span class="st">"BreaKHis 400X/test"</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>datagen_split<span class="ot">&lt;-</span> <span class="fu">image_data_generator</span>(</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">rescale =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">255</span>,            <span class="co"># Rescale pixel values to the range [0, 1]</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the batch size</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>batch_size <span class="ot">&lt;-</span> <span class="dv">32</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create separate data generators for validation and training</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="co">#Adjust the training data generator to exclude the validation subset</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>train_datagen_BreaKHis <span class="ot">&lt;-</span> <span class="fu">flow_images_from_directory</span>(</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>  train_BreaKHis_dir,</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">generator =</span> datagen_split,</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_size =</span> <span class="fu">c</span>(<span class="dv">224</span>, <span class="dv">224</span>),</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> batch_size,</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">class_mode =</span> <span class="st">"binary"</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found 1148 images belonging to 2 classes.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>validation_datagen_BreaKHis <span class="ot">&lt;-</span> <span class="fu">flow_images_from_directory</span>(</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  test_BreaKHis_dir,</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">generator =</span> datagen_split,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_size =</span> <span class="fu">c</span>(<span class="dv">224</span>, <span class="dv">224</span>),</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> batch_size,</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">class_mode =</span> <span class="st">"binary"</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found 545 images belonging to 2 classes.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Define CNN, we are going to load a premade net start.</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>efficientnetv2_b0 <span class="ot">&lt;-</span> keras<span class="sc">$</span>applications<span class="sc">$</span><span class="fu">EfficientNetV2B0</span>(</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">include_top =</span> <span class="cn">TRUE</span>,  <span class="co"># Set this to FALSE if you want to customize the top layers</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> <span class="st">"imagenet"</span>,  <span class="co"># Use pre-trained weights</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Convolutional layers</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>modelCNN_BreaKHis <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fully connected layers</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">1000</span>, <span class="at">activation =</span> <span class="st">"relu"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dropout</span>(<span class="fl">0.5</span>) <span class="sc">%&gt;%</span>  <span class="co"># Dropout for regularization</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Normlise</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_batch_normalization</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Output layer</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">1</span>, <span class="at">activation =</span> <span class="st">"sigmoid"</span>)</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile the model</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>modelCNN_BreaKHis <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="st">"binary_crossentropy"</span>,                      <span class="co"># Binary cross-entropy loss</span></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimizer =</span> <span class="fu">optimizer_rmsprop</span>(<span class="at">learning_rate =</span> <span class="fl">1e-3</span>),   <span class="co"># RMSprop optimizer </span></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="fu">c</span>(<span class="st">"accuracy"</span>)                           <span class="co"># Monitor accuracy during training</span></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Learning Rate Schedule with ReduceLRonPlateau</span></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>reduce_lr <span class="ot">&lt;-</span> <span class="fu">callback_reduce_lr_on_plateau</span>(</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">monitor =</span> <span class="st">"val_loss"</span>,</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">factor =</span> <span class="fl">0.2</span>,</span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">patience =</span> <span class="dv">5</span></span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Early Stopping</span></span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>early_stop <span class="ot">&lt;-</span> <span class="fu">callback_early_stopping</span>(</span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">monitor =</span> <span class="st">"val_loss"</span>,</span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">patience =</span> <span class="dv">10</span>,</span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">restore_best_weights =</span> <span class="cn">TRUE</span></span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a>combined_model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a>  efficientnetv2_b0 <span class="sc">%&gt;%</span></span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a>  modelCNN_BreaKHis </span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a>combined_model <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="st">"binary_crossentropy"</span>,                      <span class="co"># Binary cross-entropy loss</span></span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimizer =</span> <span class="fu">optimizer_rmsprop</span>(<span class="at">learning_rate =</span> <span class="fl">1e-3</span>),   <span class="co"># RMSprop optimizer </span></span>
<span id="cb52-49"><a href="#cb52-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="fu">c</span>(<span class="st">"accuracy"</span>)                           <span class="co"># Monitor accuracy during training</span></span>
<span id="cb52-50"><a href="#cb52-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-51"><a href="#cb52-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-52"><a href="#cb52-52" aria-hidden="true" tabindex="-1"></a><span class="co">#Not working - back to cats</span></span>
<span id="cb52-53"><a href="#cb52-53" aria-hidden="true" tabindex="-1"></a><span class="co">#train_datagen_BreaKHis&lt;-train_datagen</span></span>
<span id="cb52-54"><a href="#cb52-54" aria-hidden="true" tabindex="-1"></a><span class="co">#validation_datagen_BreaKHis&lt;-validation_datagen</span></span>
<span id="cb52-55"><a href="#cb52-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-56"><a href="#cb52-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the number of training samples</span></span>
<span id="cb52-57"><a href="#cb52-57" aria-hidden="true" tabindex="-1"></a>n_train_samples_BreaKHis <span class="ot">&lt;-</span> <span class="fu">length</span>(train_datagen_BreaKHis<span class="sc">$</span>filenames)</span>
<span id="cb52-58"><a href="#cb52-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-59"><a href="#cb52-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the number of validation samples</span></span>
<span id="cb52-60"><a href="#cb52-60" aria-hidden="true" tabindex="-1"></a>n_validation_samples_BreaKHis <span class="ot">&lt;-</span> <span class="fu">length</span>(validation_datagen_BreaKHis<span class="sc">$</span>filenames)</span>
<span id="cb52-61"><a href="#cb52-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-62"><a href="#cb52-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-63"><a href="#cb52-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-64"><a href="#cb52-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Train the CNN model with callbacks</span></span>
<span id="cb52-65"><a href="#cb52-65" aria-hidden="true" tabindex="-1"></a>combined_model <span class="ot">&lt;-</span> combined_model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb52-66"><a href="#cb52-66" aria-hidden="true" tabindex="-1"></a>  train_datagen_BreaKHis,</span>
<span id="cb52-67"><a href="#cb52-67" aria-hidden="true" tabindex="-1"></a>  <span class="at">steps_per_epoch =</span> n_train_samples_BreaKHis <span class="sc">/</span> batch_size,</span>
<span id="cb52-68"><a href="#cb52-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">10</span>,</span>
<span id="cb52-69"><a href="#cb52-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_data =</span> validation_datagen_BreaKHis,</span>
<span id="cb52-70"><a href="#cb52-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">validation_steps =</span> n_validation_samples_BreaKHis <span class="sc">/</span> batch_size,</span>
<span id="cb52-71"><a href="#cb52-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">callbacks =</span> <span class="fu">list</span>(reduce_lr, early_stop)</span>
<span id="cb52-72"><a href="#cb52-72" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/10
35/35 - 136s - loss: 0.4701 - accuracy: 0.8136 - val_loss: 0.6379 - val_accuracy: 0.6765 - lr: 0.0010 - 136s/epoch - 4s/step
Epoch 2/10
35/35 - 50s - loss: 0.3793 - accuracy: 0.8423 - val_loss: 0.6436 - val_accuracy: 0.6765 - lr: 0.0010 - 50s/epoch - 1s/step
Epoch 3/10
35/35 - 56s - loss: 0.3195 - accuracy: 0.8620 - val_loss: 0.6537 - val_accuracy: 0.6765 - lr: 0.0010 - 56s/epoch - 2s/step
Epoch 4/10
35/35 - 54s - loss: 0.3329 - accuracy: 0.8790 - val_loss: 0.6913 - val_accuracy: 0.6765 - lr: 0.0010 - 54s/epoch - 2s/step
Epoch 5/10
35/35 - 53s - loss: 0.2780 - accuracy: 0.8925 - val_loss: 0.6966 - val_accuracy: 0.6783 - lr: 0.0010 - 53s/epoch - 2s/step
Epoch 6/10
35/35 - 52s - loss: 0.2262 - accuracy: 0.9149 - val_loss: 0.7216 - val_accuracy: 0.6765 - lr: 0.0010 - 52s/epoch - 1s/step
Epoch 7/10
35/35 - 52s - loss: 0.1590 - accuracy: 0.9391 - val_loss: 0.7587 - val_accuracy: 0.6765 - lr: 2.0000e-04 - 52s/epoch - 1s/step
Epoch 8/10
35/35 - 47s - loss: 0.0764 - accuracy: 0.9713 - val_loss: 0.6870 - val_accuracy: 0.6765 - lr: 2.0000e-04 - 47s/epoch - 1s/step
Epoch 9/10
35/35 - 46s - loss: 0.0680 - accuracy: 0.9776 - val_loss: 0.5105 - val_accuracy: 0.6765 - lr: 2.0000e-04 - 46s/epoch - 1s/step
Epoch 10/10
35/35 - 48s - loss: 0.0628 - accuracy: 0.9785 - val_loss: 0.7229 - val_accuracy: 0.6783 - lr: 2.0000e-04 - 48s/epoch - 1s/step</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(combined_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CatOrDog_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><br>
</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>